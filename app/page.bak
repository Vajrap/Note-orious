"use client";
import {
  AppBar,
  Badge,
  Button,
  Container,
  CssBaseline,
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  FormControlLabel,
  List,
  ListItemButton,
  ListItemText,
  Paper,
  Stack,
  Switch,
  TextField,
  Toolbar,
  Typography,
} from "@mui/material";
import { ThemeProvider } from "@mui/material/styles";
import { createTheme } from "@mui/material/styles";
import { useCallback, useMemo, useState } from "react";
import { LocalizationProvider } from "@mui/x-date-pickers/LocalizationProvider";
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import {
  DateCalendar,
  DateTimePicker,
  PickersDay,
  PickersDayProps,
} from "@mui/x-date-pickers";
import dayjs, { Dayjs } from "dayjs";

enum Mode {
  light = "light",
  dark = "dark",
}

type Note = {
  id: number;
  title: string;
  text: string;
  tags: string[];
  dateTimeISO: string | null;
};

/*
VStack{
  HStack{
    calendar
    notes
  }
  note form
}

*/

export default function Home() {
  // Theme
  const [mode, setMode] = useState(Mode.light);
  const theme = useMemo(() => createTheme({ palette: { mode } }), [mode]);
  const toggleMode = () =>
    setMode((previous) => (previous === Mode.light ? Mode.dark : Mode.light));

  // Calendar
  const [selectedDate, setSelectedDate] = useState(dayjs());

  // Notes
  const [noteText, setNoteText] = useState("");
  const [attachTimestamp, setAttachTimeStamp] = useState(false);
  const [noteDateTime, setNoteDateTime] = useState<Dayjs>(dayjs());
  const [notes, setNotes] = useState<Note[]>([]);

  const handleSaveNote = () => {
    const trimmed = noteText.trim();
    if (!trimmed) return;

    const dateTimeISO = attachTimestamp ? noteDateTime.toISOString() : null;
    let title = "";
    let text = trimmed;
    const colonIndex = trimmed.indexOf(":");
    if (colonIndex !== -1) {
      title = trimmed.slice(0, colonIndex).trim();
      text = trimmed.slice(colonIndex + 1).trim();
    } else {
      title = trimmed.split(" ").slice(0, 4).join(" ");
    }

    const tags = Array.from(
      new Set(
        Array.from(trimmed.matchAll(/@(\w+)/g), (m) => m[1].toLowerCase()),
      ),
    );

    setNotes((prev) => [
      ...prev,
      {
        id: Date.now(),
        title,
        text,
        tags,
        dateTimeISO,
      },
    ]);
    setNoteText("");
  };

  // Display
  const datesWithNotes = useCallback(() => {
    return new Set(
      notes
        .filter((note) => !!note.dateTimeISO)
        .map((note) => dayjs(note.dateTimeISO).format("YYYY-MM-DD")),
    );
  }, [notes]);

  const noteCount = useMemo(() => {
    const map: Record<string, number> = {};
    notes.forEach((note) => {
      if (note.dateTimeISO) {
        const date = dayjs(note.dateTimeISO).format("YYYY-MM-DD");
        map[date] = (map[date] ?? 0) + 1;
      }
    });
    return map;
  }, [notes]);

  const DayBadge = useCallback(
    (props: PickersDayProps) => {
      const { day, outsideCurrentMonth, ...other } = props;
      const iso = day.format("YYYY-MM-DD");
      const hasNotes = datesWithNotes().has(iso);

      return (
        <Badge
          overlap="circular"
          badgeContent={hasNotes ? noteCount[iso] : undefined}
          color="primary"
          invisible={!hasNotes}
          sx={{
            "& .MuiBadge-badge": {
              backgroundColor: "orange",
              borderRadius: "50%",
              boxShadow: "0 0 0 1px rgba(0, 0, 0, 0.1)",
            },
          }}
        >
          <PickersDay
            day={day}
            outsideCurrentMonth={outsideCurrentMonth}
            {...other}
          />
        </Badge>
      );
    },
    [datesWithNotes, noteCount],
  );

  // show calendar on top
  // have note section with option for time stamp, if added time stamp the time will be shown on the calendar, when click on note show note modal
  // Dark / light mode changer
  // If clicked on a date on calendar which have time stamped, show note modal

  // Sub components

  const noteList = useMemo(() => {
    return notes.length === 0 ? (
      <Typography variant="body1" color="textSecondary">
        Nothing here yet. Mind writing something?
      </Typography>
    ) : (
      <Paper variant="outlined">
        <List dense disablePadding>
          {notes.map((n) => {
            const secondary = n.dateTimeISO
              ? dayjs(n.dateTimeISO).format("YYYY-MM-DD HH:mm")
              : "No timestamp";
            return (
              <ListItemButton key={n.id} onClick={() => handleNoteClick(n)}>
                <ListItemText primary={n.text} secondary={secondary} />
              </ListItemButton>
            );
          })}
        </List>
      </Paper>
    );
  }, [notes]);

  const timeStampToggler = useMemo(() => {
    return (
      <FormControlLabel
        control={
          <Switch
            checked={attachTimestamp}
            onChange={(e) => setAttachTimeStamp(e.target.checked)}
          />
        }
        label="Add timestamp"
      />
    );
  }, [attachTimestamp]);

  const timeSelector = useMemo(() => {
    return attachTimestamp ? (
      <LocalizationProvider dateAdapter={AdapterDayjs}>
        <DateTimePicker
          label="Pick date & time"
          value={noteDateTime}
          onChange={(newValue) => setNoteDateTime(newValue ?? dayjs())}
          slotProps={{ textField: { size: "small" } }}
        />
      </LocalizationProvider>
    ) : undefined;
  }, [attachTimestamp, noteDateTime]);

  // Open notes
  const [openNote, setOpenNote] = useState<Note | null>(null);
  const handleCloseNote = useCallback(() => setOpenNote(null), []);

  const handleNoteClick = (note: Note) => {
    setOpenNote(note);
  };

  const [openDay, setOpenDay] = useState<string | null>(null);
  const handleCloseDay = useCallback(() => setOpenDay(null), []);
  const calendarUnit = (
    <LocalizationProvider dateAdapter={AdapterDayjs}>
      <DateCalendar
        value={selectedDate}
        onChange={(newDate) => {
          const clicked = newDate ?? dayjs();
          const iso = clicked.format("YYYY-MM-DD");

          if (noteCount[iso]) {
            // open day modal
            setOpenDay(iso);
          } else {
            // no notes, just select date
            setSelectedDate(clicked);
          }
        }}
        slots={{ day: DayBadge }}
      />
    </LocalizationProvider>
  );

  const noteModal = useMemo(
    () => (
      <Dialog
        open={!!openNote}
        onClose={handleCloseNote}
        fullWidth
        maxWidth="sm"
      >
        <DialogTitle>Note Details</DialogTitle>
        <DialogContent dividers>
          {openNote && (
            <Stack spacing={2}>
              <Typography variant="body1" sx={{ whiteSpace: "pre-wrap" }}>
                {openNote.text}
              </Typography>
              <Typography variant="caption" color="text.secondary">
                {openNote.dateTimeISO
                  ? dayjs(openNote.dateTimeISO).format("YYYY-MM-DD HH:mm")
                  : ""}
              </Typography>
            </Stack>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseNote}>Close</Button>
        </DialogActions>
      </Dialog>
    ),
    [openNote, handleCloseNote],
  );

  const dayNotesModal = useMemo(() => {
    if (!openDay) return null;

    const dayNotes = notes.filter(
      (n) =>
        n.dateTimeISO && dayjs(n.dateTimeISO).format("YYYY-MM-DD") === openDay,
    );

    return (
      <Dialog open={!!openDay} onClose={handleCloseDay} fullWidth maxWidth="sm">
        <DialogTitle>Notes for {openDay}</DialogTitle>
        <DialogContent dividers>
          {dayNotes.length === 0 ? (
            <Typography variant="body2" color="text.secondary">
              No notes found (unexpected)
            </Typography>
          ) : (
            <List dense disablePadding>
              {dayNotes.map((n) => (
                <ListItemButton
                  key={n.id}
                  onClick={() => {
                    handleCloseDay();
                    setOpenNote(n); // open main note modal
                  }}
                >
                  <ListItemText
                    primary={n.text}
                    secondary={
                      n.dateTimeISO
                        ? dayjs(n.dateTimeISO).format("HH:mm")
                        : "No time"
                    }
                  />
                </ListItemButton>
              ))}
            </List>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseDay}>Close</Button>
        </DialogActions>
      </Dialog>
    );
  }, [openDay, notes, handleCloseDay]);

  return (
    <ThemeProvider theme={theme}>
      <CssBaseline>
        {/*Top Bar*/}
        <AppBar position="sticky">
          <Toolbar>
            <Typography variant="h6" sx={{ flexGrow: 1 }}>
              QuickNote
            </Typography>
          </Toolbar>
        </AppBar>

        <Container sx={{ py: 4 }}>
          <Stack direction="column" spacing={4} alignItems="flex-start">
            {/*Top Row*/}
            <Stack direction="row" spacing={4}>
              {/*Calendar Section*/}
              {calendarUnit}

              {/*Note list*/}
              {noteList}

              {dayNotesModal}
              {noteModal}
            </Stack>

            {/*Notes On lower part*/}
            <Stack spacing={2} minWidth="100%">
              <Typography variant="h6">Let&apos;s take a note</Typography>
              <TextField
                label="Let's take a note"
                multiline
                minRows={6}
                fullWidth
                value={noteText}
                onChange={(e) => setNoteText(e.target.value)}
                placeholder="What's in your mind...?"
              />

              <Stack direction="row" spacing={2} alignItems="center">
                {timeStampToggler}
                {timeSelector}
              </Stack>

              <Button
                variant="contained"
                onClick={handleSaveNote}
                disabled={!noteText.trim()}
                size="large"
                fullWidth
              >
                Save Note
              </Button>
            </Stack>
          </Stack>
        </Container>
        <Button onClick={toggleMode}>Try me!</Button>
      </CssBaseline>
    </ThemeProvider>
  );
}
